== 2026-02-14 19:37 == Bugfix: IRC not joining channels after connect (v1.2.0-beta.6) ==

IRC JOINs were sent before the server confirmed authentication (end of MOTD).
Twitch TMI silently drops JOINs received before auth is complete.
- Move channel joining to handleLine: trigger rejoinAll() on 376 (end of MOTD)
- Add "[IRC] Joined N channel(s)" log message for visibility
- internal/twitch/irc.go

== 2026-02-14 16:43 == Bugfix: Spade heartbeat retry on timeout (v1.2.0-beta.4) ==

Added retry logic to Spade heartbeats. Previously, a network timeout meant a lost minute-watched event
with no recovery. Now retries up to 2 times with incremental backoff (3s, 6s) before giving up.
- internal/twitch/spade.go: retry loop in sendHeartbeat with backoff

== 2026-02-14 16:34 == Bugfix: Drop auto-select channels not tracked (v1.2.0-beta.4) ==

Fixed critical bug where game-directory auto-selected channels were never recognized as drop channels.
Root cause: matchCampaignChannels only checks campaign.Channels (allowed list), so channels found via
game directory fallback were invisible to re-match, causing "Tracking N drop(s) across 0 channel(s)".

- Replace re-match with direct loginMap lookup after auto-select (internal/farmer/drops.go)
- Add zombie temp channel cleanup: remove temp channels with no campaign link and no active drop
- Prevents accumulation of orphaned temp channels across cycles

== 2026-02-13 20:48 == Feature: Enhanced Drop Miner (v1.2.0) ==

Major upgrade to the drop mining system with auto-discovery, failover, and campaign management.

Expired Campaign Cleanup:
- Campaigns past their EndAt timestamp are now skipped during processDrops()
- Prevents wasting Spade slots on stale data returned by Twitch's inventory API

Temporary Channel Infrastructure:
- New IsTemporary and CampaignID fields on ChannelState/ChannelSnapshot
- addTemporaryChannel(): adds a channel for drop tracking without saving to config
- removeTemporaryChannel(): cleans up PubSub/IRC/Spade without touching config
- RemoveChannelLive() delegates to temp removal for temporary channels
- AddChannelLive() promotes a temporary channel to permanent if user adds it manually
- Stale temporary channels (campaign ended/disabled) are auto-removed each cycle

Drop Channel Failover:
- handleDropFailover() triggers when a drop channel goes offline or raids to untracked channel
- 5-minute cooldown per campaign to prevent rapid channel cycling
- Failover strategy: try existing online channels → allowed channels → game directory
- EventStreamDown handler triggers failover if channel had active drop
- EventRaid handler triggers failover if source had active drop and target untracked
- Cooldown map cleaned periodically (entries > 30 min removed)

Auto-Select Streamers:
- New GQL query: GetGameStreams() — queries Twitch game directory for live streams
- When matchCampaignChannels() returns empty, auto-select kicks in:
  1. Try campaign's allowed channel list (check each via GetChannelInfo)
  2. Fall back to game directory (query top 10 streams)
- Found channels added as temporary with 200ms rate limiting between GQL calls
- findLiveFromAllowedChannels() and findLiveFromGameDirectory() helpers

Campaign Preferences (Enable/Disable):
- Config: DisabledCampaigns []string (omitempty, no migration needed)
- IsCampaignDisabled() and SetCampaignEnabled() on Config
- SetCampaignEnabled() on Farmer wraps config save + triggers re-evaluation
- Disabled campaigns skipped in processDrops() before any processing
- API: PUT /api/drops/{campaignID}/toggle with {"enabled": true/false}

Web UI — Drop Campaigns Table:
- New "Drop Campaigns" section between channels table and event log
- Columns: Enabled (toggle switch), Campaign, Game, Drop, Progress (bar), Channel, Expires
- Toggle switch calls PUT /api/drops/{id}/toggle to enable/disable campaigns
- Auto-selected channels show "AUTO" badge
- Disabled campaigns shown grayed out (opacity 0.4)
- Campaign expires shown as "Xd left" or "Xh left" (red if < 24h)
- Section hidden when no active drops

Web UI — Temporary Channel Badges:
- "TEMP" badge (purple) shown next to auto-added channel names
- "Auto" badge replaces "Remove" button for temporary channels
- Temporary channels cannot be removed via UI (auto-managed by drop system)

Terminal UI:
- "[TEMP]" suffix shown next to channel name for temporary channels

ActiveDrop struct enhanced with: CampaignID, EndAt, IsAutoSelected, IsEnabled

Files modified: internal/farmer/drops.go, internal/farmer/farmer.go,
  internal/farmer/channel.go, internal/twitch/gql.go, internal/twitch/types.go,
  internal/config/config.go, internal/web/server.go, internal/web/static/index.html,
  internal/ui/components.go

== 2026-02-13 02:53 == Feature: Twitch Drops Mining (v1.2.0-beta) ==

What are Twitch Drops?
  Twitch Drops are game-specific rewards (in-game items, skins, emotes, etc.) that
  players earn by watching eligible streams for a required amount of time. Normally
  you must manually find a drops-enabled stream, watch it long enough, and then
  click "Claim" on twitch.tv. TwitchPoint now automates this entire process.

How it works:
  1. Every 10 minutes, TwitchPoint queries your Twitch inventory for active drop campaigns
  2. For each campaign, it matches the allowed channels (or game category) against
     your configured channel list — it will NOT add unknown channels
  3. Matched channels are auto-promoted to P0 priority (highest), guaranteeing them
     a Spade heartbeat slot so watch minutes accumulate
  4. When a drop reaches 100% completion, it is automatically claimed via GQL mutation
  5. Once claimed (or the campaign ends), P0 is removed and the channel reverts to
     its normal priority (P1/P2)

Prerequisites:
  - drops_enabled: true in config (default)
  - Your Twitch account must be linked to the game account on the publisher's website
    (e.g., link Riot account for Valorant drops, link Steam for CS2 drops)
  - The channels streaming the drop-enabled game must be in your configured channel list

Priority system:
  P0 (drop active, auto-assigned) → P1 (always watch) → P2 (rotate every 5 min)
  P0 is temporary and fully automatic — no user action needed.

Changes:
- GQL: Inventory query to fetch active campaigns with progress per drop
- GQL: DropsPage_ClaimDropRewards mutation to auto-claim completed drops
- Farmer: dropCheckLoop() — 30s initial delay, then polls every 10 min
- Farmer: processDrops() — matches campaigns to channels, updates P0, auto-claims
- Farmer: rotateChannels() now has P0 tier (fills Spade slots before P1/P2)
- Config: drops_enabled (bool, default: true) with auto-migration for existing configs
- Terminal UI: P0 badge (green) in priority column, drop progress % in game column,
  "Drops: N" counter in stats bar
- Web UI: Active Drops stat card, P0 legend, green progress bar in channel table,
  P0 priority button (non-clickable, auto-assigned)
- API: GET /api/drops — returns all active drops with campaign, game, channel, progress
- API: /api/channels — new fields: has_active_drop, drop_name, drop_progress, drop_required
- API: /api/stats — new field: active_drops
- Files added: internal/twitch/drops.go, internal/farmer/drops.go
- Files modified: internal/farmer/channel.go, internal/farmer/farmer.go,
  internal/config/config.go, internal/ui/components.go, internal/ui/styles.go,
  internal/web/server.go, internal/web/static/index.html

== 2026-02-13 02:53 == Fix: Quit button deadlock (q key unresponsive) ==

- Fixed deadlock in IRC.Close() — mutex was held while calling send() which tried
  to acquire the same mutex again (Go mutexes are not reentrant)
- Root cause: Close() locked c.mu, then called c.send("QUIT") which also locks c.mu → deadlock
- Fix: extract conn/writer references under lock, release lock, then send QUIT and close outside
- This caused the TUI to freeze when pressing 'q' or Ctrl+C, requiring kill -9 to terminate
- Pre-existing bug, not caused by drops changes
- Files modified: internal/twitch/irc.go

== 2026-02-10 19:03 == Feature: Version number in Web UI ==

- Added version display in web UI header (e.g. "TwitchPoint Farmer v1.1.2")
- Version served via /api/stats endpoint
- Single constant in cmd/twitchpoint/main.go — update once per release

== 2026-02-10 18:57 == Fix: Game category not updating mid-stream ==

- Game category, viewer count, and broadcast ID now refresh every 5 min for all online channels
- Previously only refreshed if game name was empty — mid-stream category changes were never picked up
- Affects both Terminal UI and Web Interface

== 2026-02-10 18:57 == Fix: Web UI channel add not working ==

- Add Channel via web interface failed silently (errors only logged to console)
- Added loading state on Add button while Twitch API resolves the channel
- Added inline error display in Add Channel modal (red banner with error message)
- Added toast notification system (green = success, red = error, auto-dismiss 4s)
- All actions (add, remove, priority toggle) now show visible feedback
- Fixed silent catch blocks in remove channel and priority toggle

== 2026-02-09 22:38 == Feature: Docker Support ==

- Added Dockerfile with multi-stage build (golang:1.22-alpine -> alpine:3.19)
- Added docker-compose.yml for easy deployment
- Added .dockerignore to minimize build context
- Config mounted as volume at /app/config/config.json
- Web UI exposed on port 8080
- Minimal image size (~15MB) with stripped binary

== 2026-02-08 20:01 == Feature: IRC Viewer Presence ==

- Added Twitch IRC connection for viewer presence in channels
- Connects to irc.chat.twitch.tv:6697 (TLS) with OAuth authentication
- Auto-joins all configured channels to register as active viewer
- Benefits:
  - Counts as "active" viewer (not just passive Spade heartbeat)
  - Some channels give bonus points for chat presence
  - Better raid participation detection
- Config: irc_enabled (bool, default: true)
- Auto-reconnect with exponential backoff on disconnect
- PING/PONG keepalive every 4 minutes
- Dynamic JOIN/PART when adding/removing channels at runtime
- Files added: internal/twitch/irc.go
- Files modified: internal/config/config.go, internal/farmer/farmer.go

== 2026-02-08 04:22 == Feature: Optional Web Interface for Remote Monitoring ==

- Added optional lightweight web server for remote monitoring and control
- Uses Go's built-in net/http (zero external dependencies)
- HTML/JS embedded in binary via embed.FS for single-binary deployment
- Config fields: web_enabled (bool), web_port (int, default 8080)
- API endpoints:
  - GET /api/stats: User, uptime, total points/claims, online/watching counts
  - GET /api/channels: All channel snapshots (status, balance, earned, claims)
  - GET /api/logs: Last 50 log entries (newest first)
  - POST /api/channels: Add channel {"login": "xyz"}
  - DELETE /api/channels/{login}: Remove channel
  - PUT /api/channels/{login}/priority: Set priority {"priority": 1}
- Web UI features:
  - Dashboard header: User, Uptime, Points Earned, Claims
  - Channel table: Priority, Status, Game, Viewers, Balance, Earned, Claims
  - Add/Remove channel buttons
  - Priority toggle (click P1/P2 button to switch)
  - Auto-refresh every 5 seconds
- If web_enabled: false (default), server doesn't start, zero overhead
- Auto-migration: existing configs auto-update with new web_enabled/web_port fields on load
- Files added: internal/web/server.go, internal/web/static/index.html
- Files modified: internal/config/config.go, cmd/twitchpoint/main.go

== 2026-02-05 14:49 == Cleanup: Remove verbose debug logging ==

- Removed [Spade] heartbeat OK log (fired every 60s per channel, ~27% of total log volume)
- Removed [Spade] heartbeat loop started/stopped logs (fired every rotation cycle)
- Removed "Rotated watch to" log (fired every 5min rotation)
- Kept: heartbeat failure/error logs, initial "Started watching" on go-live, Spade URL log on startup
- Kept: all claim, raid, points-earned, stream up/down, PubSub connect/disconnect logs

== 2026-02-04 04:03 == Feature: TV Device Code OAuth Login ==

- Implemented Twitch TV Device Code OAuth flow (RFC 8628) in internal/twitch/auth.go
  - DeviceCodeLogin() orchestrates full flow: request device code, print instructions, poll for token
  - requestDeviceCode() POSTs to https://id.twitch.tv/oauth2/device with TV Client-ID
  - pollForToken() polls token endpoint every N seconds until authorization, expiry, or denial
  - Handles slow_down backoff, authorization_pending, and terminal errors
- Replaced manual "paste your auth-token cookie" first-run prompt with automatic Device Code OAuth
  - User now visits twitch.tv/activate, enters a code, and authorizes — token is obtained automatically
  - Token is natively linked to TV Client-ID, eliminating browser-token + TV-Client-ID mismatch
- Added --login flag to force re-login (replaces existing token via fresh OAuth flow)
- Exported TVClientID constant in gql.go (was unexported clientID)
- Scopes requested: channel:read:redemptions, user:read:email, chat:read, chat:edit, user:write:chat
- Root cause fix: ClaimCommunityPoints and JoinRaid "failed integrity check" was caused by
  browser-obtained auth token being used with TV Client-ID — Twitch requires integrity token for
  this combination. Device Code OAuth produces a token natively tied to the TV Client-ID, bypassing
  integrity checks entirely (same approach as MinerV2).
- Kept --token flag as manual override for advanced users

== 2026-02-03 03:36 == Fix: Missing Spade Payload Fields (live + channel) ==

- Added missing "live": true and "channel": login fields to Spade minute-watched payload
- MinerV2 reference always includes these fields; our payload only had channel_id, broadcast_id, player, user_id
- This caused some channels (e.g. HeckerYo) to not receive point credits despite HTTP 204 heartbeats
- Twitch's Spade endpoint appears to silently ignore payloads missing these fields for some channels

== 2026-02-02 16:10 == Fix: Spade Heartbeat Continuity + Broadcast ID + JoinRaid ==

- Fixed rotation killing Spade heartbeat loops every 5 min — now only stops/starts channels that actually change
  - Previously: stop ALL channels → restart selected ones (breaks heartbeat continuity, Twitch ignores interrupted sessions)
  - Now: compute diff, keep running loops for channels that stay in rotation, only modify the delta
- Fixed empty broadcast_id in Spade heartbeats — channel goes LIVE via PubSub but GQL API hasn't updated yet
  - Added retry logic (3 attempts, 5s delay) in EventStreamUp handler to fetch broadcast ID
  - Rotation now fetches broadcast ID via GQL if it's empty before starting Spade
  - tryStartWatching now rejects channels with empty broadcast_id (was silently sending empty payloads)
- Added full Spade heartbeat diagnostic logging: broadcast_id and HTTP status for every heartbeat
- Fixed JoinRaid integrity check failure: tries persisted query hash (c6a332...01a4ae) first, falls back to raw mutation
- Fixed missing game category for channels that go LIVE at runtime: retry loop now also waits for game name, not just broadcast ID
- Balance refresh now also fetches game/stream info for online channels with empty game name (fills in late API data)
- Root cause analysis: saitrixgaming/cpt_blackshark earned points from browser, not bot — TT4nn3baum only from bot, which was broken

== 2026-02-01 14:51 == Fix: PubSub Topic Subscription + Spade User-Agent ==

- Fixed PubSub only subscribing to 3/39 topics (race condition: Connect ran before channels were initialized)
- Moved PubSub Connect() to AFTER channel initialization so all topics are stored before connecting
- Added batched LISTEN (10 topics per message) to avoid Twitch "message too big" (1009) rejection
- Added WebSocket write mutex to prevent concurrent writes from Listen/Ping/Unlisten
- Added browser User-Agent header to Spade heartbeat requests (was Go-http-client/1.1, Twitch silently ignored)
- Fixed Spade URL discovery: 2-step fetch (HTML → settings JS bundle → spade_url) matching MinerV2 approach
- Removed verbose debug logging (PONG, heartbeat OK, listen OK nonces) — errors still logged

== 2026-02-01 12:20 == Fix: PubSub Reconnect Loop + Goroutine Leak ==

- Fixed exponential backoff not working: backoff only resets after connection is stable for 30+ seconds
- Previously backoff reset immediately on successful WebSocket dial, even if readLoop exited instantly
- This caused infinite 1s reconnect spam when PubSub kept dropping immediately
- Fixed ping goroutine leak: added done channel to cleanly stop ping goroutine when readLoop exits
- Previously each reconnect cycle leaked a goroutine blocked on stopped ticker
- readLoop now returns disconnect reason string for better debug logging
- Disconnect messages now include actual error (e.g. "read: connection reset" vs generic "disconnected")

== 2026-01-31 23:23 == Fix: Raw Mutations for TV Client-ID ==

- Replaced persisted query hashes with raw GQL mutation queries for ClaimCommunityPoints and JoinRaid
- Persisted query hashes were tied to the browser Client-ID and triggered "failed integrity check" with TV Client-ID
- TV Client-ID accepts raw mutations directly (no persisted hashes or integrity tokens needed)
- Removed GQLExtensions/PersistedQuery usage from both mutations

== 2026-01-31 16:47 == TV Client-ID Bypass + JoinRaid Re-enabled ==

- Switched GQL Client-ID from browser (kimne78kx3ncx6brgo4mv6wki5h1ko) to TV/Android (ue6666qo983tsx6so1t0vnawi233wa)
- TV Client-ID bypasses Twitch's Client-Integrity token (Kasada/KPSDK) requirement entirely
- Added X-Device-Id header (32 random alphanumeric chars, generated per session)
- Added Client-Session-Id header (16 random hex bytes, generated per session)
- Centralized header management in setHeaders() helper method
- Re-enabled JoinRaid API call in farmer event handler (was disabled due to integrity check failures)
- Claims and raids should now work without integrity token errors

== 2026-01-30 23:04 == Priority Channels + Watch Rotation ==

- Added priority system: P1 = always watched, P2 = rotates (Twitch only credits 2 channels at a time)
- Config now uses channel_configs with per-channel priority (auto-migrates old channels array)
- Rotation every 5 min: P1 channels always hold their Spade slots, remaining slots cycle through P2
- Added 'p' key in TUI to set priority (format: "channelname 1" or "channelname 2")
- Priority column shown in channel table (P1 highlighted yellow, P2 gray)
- SetPriorityLive triggers immediate rotation when priority changes
- Silenced Go default logger to prevent log bleed behind TUI alt screen
- Removed debug log from PubSub community points handler
- Fixed balance field name in CommunityPointsEvent (balance instead of current_points)
- Reverted maxWatchedChannels to 2 (Twitch server-side limit)

== 2026-01-30 22:36 == Fix Spade URL (no such host) ==

- Fixed fallback Spade URL from non-existent video-edge-detector.twitch.tv to correct endpoint https://spade.twitch.tv/track
- Improved fetchSpadeURL to try multiple regex patterns for spade URL extraction
- Added proper User-Agent and Accept headers for Twitch page fetch

== 2026-01-30 22:32 == Fix GQL PersistedQueryNotFound ==

- Replaced all persisted query hashes with inline raw GQL queries in internal/twitch/gql.go
- Persisted query hashes are tied to Twitch's frontend build and go stale on updates
- Raw queries always work regardless of Twitch frontend version
- Simplified GetChannelInfo from batch request to single query
- Removed unused doBatch method dependency for channel info

== 2026-01-30 22:25 == Initial Implementation - TwitchPoint Farmer ==

- Created Go project structure with module github.com/miwi/twitchpoint
- Implemented internal/twitch/types.go: All PubSub, GQL, Spade, and event type definitions
- Implemented internal/config/config.go: JSON config loader with add/remove channel support
- Implemented internal/twitch/gql.go: GQL API client (GetUserInfo, GetChannelInfo, ClaimCommunityPoints, JoinRaid, GetChannelPointsBalance)
- Implemented internal/twitch/pubsub.go: PubSub WebSocket client with auto-reconnect, PING/PONG keepalive, topic subscription, event parsing for community points, video playback, and raids
- Implemented internal/twitch/spade.go: Spade minute-watched heartbeat tracker with max 2 concurrent channel limit, spade URL extraction from Twitch page
- Implemented internal/farmer/channel.go: Per-channel state tracking with thread-safe snapshots
- Implemented internal/farmer/farmer.go: Main orchestrator tying GQL, PubSub, and Spade together with event loop, auto-claim, auto-raid-join, balance refresh, and priority-based Spade slot filling
- Implemented internal/ui/styles.go: Lipgloss style definitions (Twitch purple theme)
- Implemented internal/ui/components.go: TUI components (header, channel table, stats bar, event log, help bar)
- Implemented internal/ui/app.go: Bubbletea TUI application with keyboard controls (q=quit, a=add channel, d=remove channel)
- Implemented cmd/twitchpoint/main.go: CLI entry point with --config, --add-channel, --token flags and first-run setup wizard
- Created Makefile with build, build-all (macOS/Linux/Windows cross-compilation), run, and clean targets
- Verified successful builds for all three platforms (darwin/arm64, linux/amd64, windows/amd64)
